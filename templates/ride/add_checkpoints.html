{% extends "partials/base.html" %}
{% block title %}Add Checkpoints - {{ ride.name }}{% endblock %}

{% block extra_css %}
<style>
.checkpoint-section {
    background: var(--bg-card);
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    border: 2px solid var(--border-color);
}

.checkpoint-section.completed {
    border-color: var(--accent-green);
    background: rgba(74, 222, 128, 0.05);
}

.checkpoint-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.checkpoint-icon {
    font-size: 2rem;
}

.checkpoint-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
}

#map {
    width: 100%;
    height: 400px;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    border: 2px solid var(--border-color);
}

.search-box {
    position: relative;
    margin-bottom: 1rem;
}

.pac-container {
    z-index: 10000 !important;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 8px;
}

.pac-item {
    color: var(--text-primary);
    padding: 8px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
}

.pac-item:hover {
    background: var(--bg-secondary);
}

.pac-item-query {
    color: var(--text-primary);
}

.saved-location {
    background: var(--bg-secondary);
    padding: 0.75rem;
    border-radius: 6px;
    margin-top: 0.5rem;
    color: var(--accent-green);
    font-size: 0.875rem;
    display: none;
}

.progress-bar {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.progress-fill {
    height: 8px;
    background: var(--accent-green);
    border-radius: 4px;
    transition: width 0.3s;
}
</style>
{% endblock %}

{% block navbar %}{% include 'partials/navbar.html' %}{% endblock %}

{% block content %}
<main class="container">
    <div class="breadcrumb">
        <a href="{{ url_for('organization_rides_page', org_id=organization.id) }}">Rides</a>
        <span>/</span>
        <span>Add Checkpoints</span>
    </div>

    <div class="card">
        <div class="card-header">
            <h2>Add Checkpoints: {{ ride.name }}</h2>
        </div>
    </div>

    <!-- Progress -->
    <div class="progress-bar">
        <div style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.5rem;">
            Progress: <span id="progress-count">0</span> of 3 required
        </div>
        <div style="background: var(--border-color); height: 8px; border-radius: 4px;">
            <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
        </div>
    </div>

    <!-- Map -->
    <div class="card">
        <div class="card-body">
            <div class="search-box">
                <input
                    id="search-input"
                    class="form-control"
                    type="text"
                    placeholder="Search for a location (e.g., Nandi Hills, Bangalore)"
                >
            </div>
            <div id="map"></div>
            <p style="color: var(--text-secondary); font-size: 0.875rem; text-align: center; margin-top: 0.5rem;">
                üîç Search or click on the map to select a location
            </p>
        </div>
    </div>

    <!-- Current Checkpoint Selection -->
    <div class="checkpoint-section" id="current-checkpoint">
        <div class="checkpoint-header">
            <span class="checkpoint-icon" id="current-icon">üèÅ</span>
            <div>
                <div class="checkpoint-title" id="current-title">Select Meetup Point</div>
                <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0.25rem 0 0 0;" id="current-desc">
                    Where riders will gather before the ride
                </p>
            </div>
        </div>
        <div id="current-location" class="saved-location"></div>
        <button class="btn btn-primary" onclick="saveCurrentCheckpoint()" id="save-btn" disabled>
            Save Checkpoint
        </button>
    </div>

    <!-- Summary of Saved Checkpoints -->
    <div id="saved-checkpoints"></div>

    <!-- Finalize -->
    <button class="btn btn-primary" onclick="finalizeRide()" id="finalize-btn" style="width: 100%; margin-top: 1rem;" disabled>
        Finalize & Publish Ride ‚Üí
    </button>
</main>
{% endblock %}

{% block footer %}{% include 'partials/footer.html' %}{% endblock %}

{% block extra_js %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_key }}&libraries=places&callback=initMap" async defer></script>
<script>
const RIDE_ID = '{{ ride.id }}';
const ORG_ID = '{{ organization.id }}';

let map;
let marker;
let currentCheckpoint = {
    step: 0,
    types: ['meetup', 'destination', 'disbursement'],
    icons: ['üèÅ', 'üéØ', 'üè†'],
    titles: ['Meetup Point', 'Destination', 'Disbursement Point'],
    descs: [
        'Where riders will gather before the ride',
        'Final destination of the ride',
        'Where riders will part ways'
    ],
    data: null
};

let savedCheckpoints = [];

function initMap() {
    // Default to Bangalore, India
    const defaultLocation = { lat: 12.9716, lng: 77.5946 };

    map = new google.maps.Map(document.getElementById('map'), {
        center: defaultLocation,
        zoom: 12,
        styles: [
            { elementType: "geometry", stylers: [{ color: "#242424" }] },
            { elementType: "labels.text.stroke", stylers: [{ color: "#242424" }] },
            { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
            {
                featureType: "administrative.locality",
                elementType: "labels.text.fill",
                stylers: [{ color: "#d59563" }]
            },
            {
                featureType: "poi",
                elementType: "labels.text.fill",
                stylers: [{ color: "#d59563" }]
            },
            {
                featureType: "poi.park",
                elementType: "geometry",
                stylers: [{ color: "#263c3f" }]
            },
            {
                featureType: "road",
                elementType: "geometry",
                stylers: [{ color: "#38414e" }]
            },
            {
                featureType: "road.highway",
                elementType: "geometry",
                stylers: [{ color: "#4ade80" }]
            },
            {
                featureType: "water",
                elementType: "geometry",
                stylers: [{ color: "#17263c" }]
            }
        ]
    });

    // Search box
    const input = document.getElementById('search-input');
    const searchBox = new google.maps.places.SearchBox(input);

    map.addListener('bounds_changed', () => {
        searchBox.setBounds(map.getBounds());
    });

    searchBox.addListener('places_changed', () => {
        const places = searchBox.getPlaces();
        if (places.length === 0) return;

        const place = places[0];
        if (!place.geometry || !place.geometry.location) return;

        selectLocation(
            place.geometry.location.lat(),
            place.geometry.location.lng(),
            place.formatted_address || place.name
        );

        map.setCenter(place.geometry.location);
        map.setZoom(15);
    });

    // Click on map to select
    map.addListener('click', (e) => {
        const lat = e.latLng.lat();
        const lng = e.latLng.lng();

        // Reverse geocode to get address
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ location: { lat, lng } }, (results, status) => {
            if (status === 'OK' && results[0]) {
                selectLocation(lat, lng, results[0].formatted_address);
            } else {
                selectLocation(lat, lng, `${lat.toFixed(6)}, ${lng.toFixed(6)}`);
            }
        });
    });

    // Try to get user's location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                map.setCenter(pos);
            },
            () => {
                console.log('Location access denied, using default location');
            }
        );
    }
}

function selectLocation(lat, lng, address) {
    currentCheckpoint.data = { lat, lng, address };

    // Update marker
    if (marker) marker.setMap(null);

    marker = new google.maps.Marker({
        position: { lat, lng },
        map: map,
        animation: google.maps.Animation.DROP,
        icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: '#4ade80',
            fillOpacity: 1,
            strokeColor: '#ffffff',
            strokeWeight: 2
        }
    });

    // Show selected location
    document.getElementById('current-location').innerHTML = `üìç ${address}`;
    document.getElementById('current-location').style.display = 'block';
    document.getElementById('save-btn').disabled = false;
}

async function saveCurrentCheckpoint() {
    const btn = document.getElementById('save-btn');
    const data = currentCheckpoint.data;
    const type = currentCheckpoint.types[currentCheckpoint.step];

    btn.disabled = true;
    btn.textContent = 'Saving...';

    try {
        const response = await fetch(`/v1/rides/${RIDE_ID}/checkpoints/add`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                type: type,
                latitude: data.lat,
                longitude: data.lng,
                address: data.address
            })
        });

        if (!response.ok) throw new Error('Failed to save');

        // Save to local array
        savedCheckpoints.push({
            type: type,
            icon: currentCheckpoint.icons[currentCheckpoint.step],
            title: currentCheckpoint.titles[currentCheckpoint.step],
            address: data.address
        });

        // Show in summary
        updateSummary();

        // Move to next checkpoint
        currentCheckpoint.step++;

        if (currentCheckpoint.step < 3) {
            // Next checkpoint
            document.getElementById('current-icon').textContent = currentCheckpoint.icons[currentCheckpoint.step];
            document.getElementById('current-title').textContent = `Select ${currentCheckpoint.titles[currentCheckpoint.step]}`;
            document.getElementById('current-desc').textContent = currentCheckpoint.descs[currentCheckpoint.step];
            document.getElementById('current-location').style.display = 'none';
            document.getElementById('search-input').value = '';
            btn.textContent = 'Save Checkpoint';
            btn.disabled = true;
            currentCheckpoint.data = null;
            if (marker) marker.setMap(null);
        } else {
            // All done
            document.getElementById('current-checkpoint').style.display = 'none';
            document.getElementById('finalize-btn').disabled = false;
        }

        updateProgress();

    } catch (error) {
        console.error(error);
        alert('Failed to save checkpoint');
        btn.textContent = 'Save Checkpoint';
        btn.disabled = false;
    }
}

function updateSummary() {
    const container = document.getElementById('saved-checkpoints');
    container.innerHTML = savedCheckpoints.map(cp => `
        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <span style="font-size: 1.5rem;">${cp.icon}</span>
                <div>
                    <div style="font-weight: 600; color: var(--text-primary);">${cp.title}</div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">${cp.address}</div>
                </div>
                <span style="margin-left: auto; color: var(--accent-green);">‚úì</span>
            </div>
        </div>
    `).join('');
}

function updateProgress() {
    const count = savedCheckpoints.length;
    document.getElementById('progress-count').textContent = count;
    document.getElementById('progress-fill').style.width = `${(count / 3) * 100}%`;
}

async function finalizeRide() {
    const btn = document.getElementById('finalize-btn');
    btn.disabled = true;
    btn.textContent = 'Publishing...';

    try {
        const response = await fetch(`/v1/rides/${RIDE_ID}/finalize`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) throw new Error('Failed');

        window.location.href = `/v1/organizations/${ORG_ID}/rides/${RIDE_ID}`;

    } catch (error) {
        alert('Failed to finalize ride');
        btn.textContent = 'Finalize & Publish Ride ‚Üí';
        btn.disabled = false;
    }
}
</script>
{% endblock %}